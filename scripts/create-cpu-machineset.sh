#!/usr/bin/env bash
#
# create-cpu-machineset.sh - Create CPU worker MachineSet with auto-discovery
#
# Creates dedicated CPU worker nodes separate from master/infra nodes.
# Useful for RHOAI workloads that need dedicated compute resources.
#
# Usage:
#   ./create-cpu-machineset.sh [OPTIONS]
#
# Options:
#   --instance-type TYPE   Instance type (default: m5.2xlarge)
#   --replicas N           Number of replicas (default: 2)
#   --az ZONE              Availability zone (default: auto-detected)
#   --volume-size GB       Root volume size in GB (default: 120)
#   --min N                Minimum replicas for autoscaling (default: 1)
#   --max N                Maximum replicas for autoscaling (default: 3)
#   --dry-run              Preview without applying
#
# The script always waits for the CPU worker node(s) to be Ready before exiting.
#
# Environment variables (can also be set in .env):
#   CPU_INSTANCE_TYPE, CPU_REPLICAS, CPU_AZ, CPU_VOLUME_SIZE, CPU_MIN, CPU_MAX

set -euo pipefail

SCRIPT_DIR="$(cd "$(dirname "${BASH_SOURCE[0]}")" && pwd)"
REPO_ROOT="$(cd "$SCRIPT_DIR/.." && pwd)"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
NC='\033[0m'

log_info()  { echo -e "${GREEN}[INFO]${NC} $*"; }
log_warn()  { echo -e "${YELLOW}[WARN]${NC} $*"; }
log_error() { echo -e "${RED}[ERROR]${NC} $*"; }

# Defaults (can be overridden by env vars or CLI args)
INSTANCE_TYPE="${CPU_INSTANCE_TYPE:-${INSTANCE_TYPE:-m5.4xlarge}}"
REPLICAS="${CPU_REPLICAS:-${REPLICAS:-1}}"
AZ="${CPU_AZ:-}"
VOLUME_SIZE="${CPU_VOLUME_SIZE:-${VOLUME_SIZE:-120}}"
AUTOSCALE_MIN="${CPU_MIN:-1}"
AUTOSCALE_MAX="${CPU_MAX:-3}"
DRY_RUN=false

while [[ $# -gt 0 ]]; do
    case $1 in
        --instance-type) INSTANCE_TYPE="$2"; shift 2 ;;
        --replicas) REPLICAS="$2"; shift 2 ;;
        --az) AZ="$2"; shift 2 ;;
        --volume-size) VOLUME_SIZE="$2"; shift 2 ;;
        --min) AUTOSCALE_MIN="$2"; shift 2 ;;
        --max) AUTOSCALE_MAX="$2"; shift 2 ;;
        --dry-run) DRY_RUN=true; shift ;;
        -h|--help)
            cat <<EOF
Usage: $0 [OPTIONS]

Creates dedicated CPU worker nodes separate from master/infra nodes.

Options:
  --instance-type TYPE   Instance type (default: m5.4xlarge)
  --replicas N           Number of replicas (default: 1)
  --az ZONE              Availability zone (default: auto-detected)
  --volume-size GB       Root volume size in GB (default: 120)
  --min N                Minimum replicas for autoscaling (default: 1)
  --max N                Maximum replicas for autoscaling (default: 3)
  --dry-run              Preview without applying

The script always waits for CPU worker node(s) to be Ready before exiting.

Autoscaling:
  Autoscaling is enabled by default. The script will:
  1. Create a ClusterAutoscaler (if not exists)
  2. Create a MachineAutoscaler for the CPU MachineSet
  3. Set initial replicas to --min value

Common instance types:
  m5.xlarge      4 vCPU,  16GB RAM  - Light workloads
  m5.2xlarge     8 vCPU,  32GB RAM  - Default, general purpose
  m5.4xlarge    16 vCPU,  64GB RAM  - Medium workloads
  m5.8xlarge    32 vCPU, 128GB RAM  - Heavy workloads
  m6i.xlarge     4 vCPU,  16GB RAM  - Latest gen, general purpose
  c5.2xlarge     8 vCPU,  16GB RAM  - Compute optimized
  r5.2xlarge     8 vCPU,  64GB RAM  - Memory optimized

Environment variables (can also be set in .env):
  CPU_INSTANCE_TYPE, CPU_REPLICAS, CPU_AZ, CPU_VOLUME_SIZE
EOF
            exit 0
            ;;
        *) log_error "Unknown option: $1"; exit 1 ;;
    esac
done

# Verify cluster connection
if ! oc whoami &>/dev/null; then
    log_error "Not logged into OpenShift cluster"
    exit 1
fi

log_info "Connected to: $(oc whoami --show-server)"

# Check if CPU worker MachineSet already exists
if oc get machineset -n openshift-machine-api -o name 2>/dev/null | grep -q "cpu-worker"; then
    log_info "CPU worker MachineSet already exists, will update if needed"
    oc get machineset -n openshift-machine-api | grep cpu-worker
fi

# Verify AWS platform
PLATFORM=$(oc get infrastructure cluster -o jsonpath='{.status.platform}' 2>/dev/null || echo "unknown")
if [[ "$PLATFORM" != "AWS" ]]; then
    log_error "This script only supports AWS. Detected platform: $PLATFORM"
    exit 1
fi

# Auto-discover cluster values
log_info "Auto-discovering cluster values..."

INFRA_ID=$(oc get infrastructure cluster -o jsonpath='{.status.infrastructureName}')
log_info "  Infrastructure ID: $INFRA_ID"

# Get reference worker MachineSet (not gpu, not infra)
REF_MS=$(oc get machineset -n openshift-machine-api -o name | grep -v gpu | grep -v infra | head -1 | cut -d/ -f2)
if [[ -z "$REF_MS" ]]; then
    log_error "No existing worker MachineSet found to use as reference"
    exit 1
fi
log_info "  Reference MachineSet: $REF_MS"

# Extract values
REGION=$(oc get machineset "$REF_MS" -n openshift-machine-api -o jsonpath='{.spec.template.spec.providerSpec.value.placement.region}')
DISCOVERED_AZ=$(oc get machineset "$REF_MS" -n openshift-machine-api -o jsonpath='{.spec.template.spec.providerSpec.value.placement.availabilityZone}')
AMI=$(oc get machineset "$REF_MS" -n openshift-machine-api -o jsonpath='{.spec.template.spec.providerSpec.value.ami.id}')
SUBNET=$(oc get machineset "$REF_MS" -n openshift-machine-api -o jsonpath='{.spec.template.spec.providerSpec.value.subnet.filters[0].values[0]}')
IAM_PROFILE=$(oc get machineset "$REF_MS" -n openshift-machine-api -o jsonpath='{.spec.template.spec.providerSpec.value.iamInstanceProfile.id}')
SG=$(oc get machineset "$REF_MS" -n openshift-machine-api -o jsonpath='{.spec.template.spec.providerSpec.value.securityGroups[0].filters[0].values[0]}')

# Use discovered AZ if not specified
if [[ -z "$AZ" ]]; then
    AZ="$DISCOVERED_AZ"
fi

# Handle autoscaling configuration (enabled by default with min=1, max=3)
AUTOSCALING_ENABLED=true
REPLICAS="$AUTOSCALE_MIN"
log_info "  Autoscaling: enabled (min=$AUTOSCALE_MIN, max=$AUTOSCALE_MAX)"

log_info "  Region: $REGION"
log_info "  Availability Zone: $AZ"
log_info "  AMI: $AMI"
log_info "  Instance Type: $INSTANCE_TYPE"
log_info "  Replicas: $REPLICAS"
log_info "  Volume Size: ${VOLUME_SIZE}GB"

MS_NAME="${INFRA_ID}-cpu-worker-${AZ##*-}"

# Generate MachineSet YAML from template
TEMPLATE_FILE="$REPO_ROOT/bootstrap/cpu-machineset/cpu-machineset-template.yaml"
if [[ ! -f "$TEMPLATE_FILE" ]]; then
    log_error "Template file not found: $TEMPLATE_FILE"
    exit 1
fi

export MS_NAME INFRA_ID REPLICAS AMI INSTANCE_TYPE AZ REGION SUBNET IAM_PROFILE SG VOLUME_SIZE
MACHINESET_YAML=$(envsubst < "$TEMPLATE_FILE")

# Dry-run or apply
if [[ "$DRY_RUN" == "true" ]]; then
    log_info "[DRY-RUN] Would apply:"
    echo "$MACHINESET_YAML"
    echo "$MACHINESET_YAML" | oc apply --dry-run=client -f -
    log_info "[DRY-RUN] Complete - no changes made"
    exit 0
fi

echo "$MACHINESET_YAML" | oc apply -f -
log_info "CPU worker MachineSet created: $MS_NAME"

# Create autoscaling resources if enabled
if [[ "$AUTOSCALING_ENABLED" == "true" ]]; then
    log_info "Creating autoscaling resources..."

    # Create ClusterAutoscaler if it doesn't exist
    if ! oc get clusterautoscaler default &>/dev/null; then
        log_info "Creating ClusterAutoscaler..."
        cat <<EOF | oc apply -f -
apiVersion: autoscaling.openshift.io/v1
kind: ClusterAutoscaler
metadata:
  name: default
spec:
  podPriorityThreshold: -10
  scaleDown:
    delayAfterAdd: 20m
    delayAfterDelete: 5m
    delayAfterFailure: 30s
    enabled: true
    unneededTime: 5m
EOF
        log_info "ClusterAutoscaler created"
    else
        log_info "ClusterAutoscaler already exists"
    fi

    # Create MachineAutoscaler for this MachineSet
    log_info "Creating MachineAutoscaler for $MS_NAME..."
    cat <<EOF | oc apply -f -
apiVersion: autoscaling.openshift.io/v1beta1
kind: MachineAutoscaler
metadata:
  name: $MS_NAME
  namespace: openshift-machine-api
spec:
  minReplicas: $AUTOSCALE_MIN
  maxReplicas: $AUTOSCALE_MAX
  scaleTargetRef:
    apiVersion: machine.openshift.io/v1beta1
    kind: MachineSet
    name: $MS_NAME
EOF
    log_info "MachineAutoscaler created: $MS_NAME (min=$AUTOSCALE_MIN, max=$AUTOSCALE_MAX)"
fi

# Always wait for CPU worker node to be Ready
log_info "Waiting for CPU worker node to be Ready (this may take 5-15 minutes)..."

TIMEOUT=1200  # 20 minutes
INTERVAL=15
ELAPSED=0

while [[ $ELAPSED -lt $TIMEOUT ]]; do
    # Check Machine status first
    MACHINE_STATUS=$(oc get machines -n openshift-machine-api -l machine.openshift.io/cluster-api-machineset=$MS_NAME -o jsonpath='{.items[0].status.phase}' 2>/dev/null || echo "Unknown")

    NODE=$(oc get nodes -l node-role.kubernetes.io/cpu-worker -o name 2>/dev/null | head -1)
    if [[ -n "$NODE" ]]; then
        READY=$(oc get "$NODE" -o jsonpath='{.status.conditions[?(@.type=="Ready")].status}' 2>/dev/null || echo "Unknown")
        if [[ "$READY" == "True" ]]; then
            log_info "CPU worker node is Ready!"
            oc get nodes -l node-role.kubernetes.io/cpu-worker
            exit 0
        fi
        log_info "CPU worker node exists but not Ready yet (Machine: $MACHINE_STATUS, Node Ready: $READY)"
    else
        log_info "Waiting for CPU worker node... (Machine phase: $MACHINE_STATUS)"
    fi

    sleep $INTERVAL
    ELAPSED=$((ELAPSED + INTERVAL))
done

log_warn "Timeout waiting for CPU worker node after $TIMEOUT seconds"
log_warn "Check machine status: oc get machines -n openshift-machine-api | grep cpu-worker"
log_warn "Check events: oc get events -n openshift-machine-api --sort-by='.lastTimestamp' | tail -20"
exit 1
